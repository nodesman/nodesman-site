// Generated by CoffeeScript 1.9.1
(function() {
  var Viff, _, cases, config, consoleStatus, count, exceptions, group, i, imgGen, len, processArgs, ref, resolvedCases, testGroups, viff;

  _ = require('underscore');

  Viff = require('./viff.js');

  processArgs = require('./process.argv.js');

  consoleStatus = require('./console.status.js');

  imgGen = require('./image.generator');

  config = processArgs(process.argv);

  if (_.isString(config)) {
    return console.log(config);
  }

  count = (ref = config.maxInstance) != null ? ref : 1;

  cases = Viff.constructCases(config.browsers, config.envHosts, config.paths);

  testGroups = Viff.split(cases, count);

  resolvedCases = [];

  exceptions = [];

  imgGen.reset();

  consoleStatus.logBefore();

  for (i = 0, len = testGroups.length; i < len; i++) {
    group = testGroups[i];
    viff = new Viff(config.seleniumHost);
    viff.on('afterEach', function(_case, duration, fex, tex) {
      if (duration !== 0) {
        imgGen.generateByCase(_case);
      }
      return consoleStatus.logAfterEach(_case, duration, fex, tex, exceptions);
    });
    viff.run(group, function(arg) {
      var cases, duration;
      cases = arg[0], duration = arg[1];
      resolvedCases = resolvedCases.concat(cases);
      if (!--count) {
        imgGen.generateReport(resolvedCases);
        return consoleStatus.logAfter(resolvedCases, duration, exceptions);
      }
    });
  }

}).call(this);

// Generated by CoffeeScript 1.9.1
(function() {
  var Viff, _, _eval, app, consoleStatus, imgGen, partialCanvas, processArgs, resemble;

  _ = require('underscore');

  Viff = require('./viff.js');

  processArgs = require('./process.argv.js');

  consoleStatus = require('./console.status.js');

  imgGen = require('./image.generator');

  _eval = require('./node.eval');

  resemble = require('./resemble');

  partialCanvas = require('./canvas.drawimage');

  app = function(config) {
    var cases, viff;
    if (_.isString(config)) {
      return console.log(config);
    }
    viff = new Viff(config.seleniumHost);
    if (config.reportFormat === 'file') {
      consoleStatus(viff);
      viff.on('before', function(cases) {
        return imgGen.reset();
      });
      viff.on('afterEach', function(_case, duration) {
        if (duration !== 0) {
          return imgGen.generateByCase(_case);
        }
      });
      viff.on('after', function(cases, duration) {
        imgGen.generateReport(cases);
        resemble.exit();
        return partialCanvas.exit();
      });
    }
    cases = Viff.constructCases(config.browsers, config.envHosts, config.paths);
    return viff.run(cases);
  };

  process.stdin.on('readable', function() {
    var configstr;
    if (null !== (configstr = process.stdin.read())) {
      return app(processArgs(_eval(configstr)));
    }
  });

}).call(this);
